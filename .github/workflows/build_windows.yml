name: Build Windows Installer

on:
  push:
    branches: [ "main" ]
    paths:
      - 'Windows/**'
      - 'target_url'
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-latest

    steps:
    - name: Checkout Code
      uses: actions/checkout@v4

    - name: Setup MSBuild (for CSC)
      uses: microsoft/setup-msbuild@v1

    - name: Install Inno Setup
      run: choco install innosetup

    - name: Configure and Compile Launcher
      shell: powershell
      run: |
        # 1. Read URL from root file
        $url = Get-Content target_url -Raw
        $url = $url.Trim()
        
        if ([string]::IsNullOrWhiteSpace($url)) {
          Write-Error "Target URL is empty!"
          exit 1
        }
        Write-Host "Compiling with URL: $url"

        # 2. Inject URL into C# Code
        $CsPath = "Windows/Launcher.cs"
        $Code = Get-Content $CsPath -Raw
        $Code = $Code.Replace('REPLACE_ME_URL', $url)
        Set-Content $CsPath $Code

        # 3. Compile C# to EXE
        # We output it directly to the Windows folder so Inno Setup can find it
        csc /target:exe /out:Windows/StremioNeoLauncher.exe /r:Microsoft.CSharp.dll Windows/Launcher.cs

    - name: Build Installer
      # Runs Inno Setup on the script
      run: iscc Windows/installer.iss

    - name: Upload Setup.exe
      uses: actions/upload-artifact@v4
      with:
        name: StremioNeo-Setup
        path: Windows/build/StremioNeo-Setup.exe