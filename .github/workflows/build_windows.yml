name: Build Windows Installer

on:
  push:
    branches: [ "main" ]
    paths:
      - 'Windows/**'
      - 'target_url'
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-latest

    steps:
    - name: Checkout Code
      uses: actions/checkout@v4

    - name: Install Inno Setup
      run: choco install innosetup

    - name: Configure and Compile Launcher
      shell: powershell
      working-directory: ${{ github.workspace }}
      run: |
        # 1. Read URL from the 'target_url' file in the root
        $TargetUrlPath = Join-Path $PWD "target_url"
        $url = Get-Content $TargetUrlPath -Raw
        $url = $url.Trim()

        if ([string]::IsNullOrWhiteSpace($url)) {
          Write-Error "Target URL is empty in 'target_url' file!"
          exit 1
        }
        Write-Host "Compiling with URL: $url"

        # 2. Inject URL into C# Code (Launcher.cs)
        $CsPath = Join-Path $PWD "Windows/Launcher.cs"
        $Code = Get-Content $CsPath -Raw
        # This replaces the placeholder text in your C# file with the real URL
        $Code = $Code.Replace('REPLACE_ME_URL', $url)
        Set-Content $CsPath $Code

        # 3. Compile C# to EXE using the built-in Windows Compiler
        # We use the absolute path to csc.exe to avoid "command not found" errors
        $CSC = "C:\Windows\Microsoft.NET\Framework64\v4.0.30319\csc.exe"

        # Use absolute paths to avoid path resolution issues
        $CsFilePath = Join-Path $PWD "Windows/Launcher.cs"
        $OutputPath = Join-Path $PWD "Windows/StremioNeoLauncher.exe"

        & $CSC /target:exe /out:$OutputPath /r:Microsoft.CSharp.dll $CsFilePath

    - name: Build Installer
      # Runs Inno Setup on the script
      shell: powershell
      working-directory: ${{ github.workspace }}
      run: |
        $InstallerPath = Join-Path $PWD "Windows/installer.iss"
        iscc $InstallerPath

    - name: Upload Setup.exe
      uses: actions/upload-artifact@v4
      with:
        name: StremioNeo-Setup
        path: Windows/build/StremioNeo-Setup.exe